<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>YouTube Embed Relay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #youtube-player {
            width: 100%;
            height: 100%;
        }
        .go-to-reference-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .go-to-reference-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.4);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        .go-to-reference-btn:active {
            transform: translateY(0);
        }
        .go-to-reference-btn.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="youtube-player"></div>
    <button id="go-to-reference-btn" class="go-to-reference-btn hidden">
        <span>ðŸŽ¯</span>
        <span>Go to reference</span>
    </button>

    <!-- Load YouTube iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // Helper function to extract timestamp from URL or time string
        function extractTimestamp(url) {
            if (!url) return null;

            // First, check if it's a time format like "1:17" or "1:23:45"
            const timeMatch = url.match(/^(\d+):(\d+)(?::(\d+))?$/);
            if (timeMatch) {
                const hours = timeMatch[3] ? parseInt(timeMatch[1]) : 0;
                const minutes = timeMatch[3] ? parseInt(timeMatch[2]) : parseInt(timeMatch[1]);
                const seconds = timeMatch[3] ? parseInt(timeMatch[3]) : parseInt(timeMatch[2]);
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                return totalSeconds;
            }

            // Check URL parameter patterns
            const patterns = [
                /[?&]t=(\d+)s?/,
                /[?&]start=(\d+)/,
                /#t=(\d+)s?/,
                /[?&]time_continue=(\d+)/,
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return parseInt(match[1]);
                }
            }

            return null;
        }

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('v');
        const timestampParam = urlParams.get('timestamp') || urlParams.get('t');
        const startParam = urlParams.get('start') || '0';

        let player = null;
        let playerReady = false;

        if (!videoId) {
            document.body.textContent = 'Missing video ID parameter. Use ?v=VIDEO_ID';
            document.body.style.color = '#fff';
            document.body.style.padding = '20px';
            document.body.style.fontFamily = 'Arial, sans-serif';
        } else {
            // Show "Go to reference" button if timestamp is provided
            const timestamp = extractTimestamp(timestampParam);
            const goToBtn = document.getElementById('go-to-reference-btn');

            if (timestamp !== null && timestamp > 0) {
                goToBtn.classList.remove('hidden');
                goToBtn.onclick = function() {
                    if (playerReady && player) {
                        player.seekTo(timestamp, true); // true = allow seeking, but we'll play manually
                        player.playVideo(); // Explicitly play after seeking
                        console.log('Seeking to timestamp:', timestamp);
                    }
                };
            }

            // Wait for YouTube API to load
            function onYouTubeIframeAPIReady() {
                const currentOrigin = window.location.origin;
                const startSeconds = parseInt(startParam) || 0;

                // Use YouTube iframe API - same as in your component
                // This uses the same API that doesn't show ads
                player = new YT.Player('youtube-player', {
                    videoId: videoId,
                    playerVars: {
                        enablejsapi: 1,
                        origin: currentOrigin,
                        start: startSeconds,
                        autoplay: 0,
                        rel: 0,
                        modestbranding: 1,
                        playsinline: 1,
                    },
                    events: {
                        onReady: function(event) {
                            playerReady = true;
                            console.log('YouTube player ready in relay');
                            // Set referrer policy on the iframe
                            const iframe = event.target.getIframe();
                            if (iframe) {
                                iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
                            }

                            // If timestamp is provided and start is 0, seek to timestamp on ready (but don't autoplay)
                            if (timestamp !== null && timestamp > 0 && startSeconds === 0) {
                                event.target.seekTo(timestamp, false); // false = don't autoplay
                            }
                        },
                        onError: function(event) {
                            console.error('YouTube player error:', event.data);
                        }
                    }
                });
            }

            // If API is already loaded
            if (window.YT && window.YT.Player) {
                onYouTubeIframeAPIReady();
            } else {
                // Wait for API to load
                window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
            }
        }
    </script>
</body>
</html>
