<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>YouTube Embed Relay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            overflow: auto;
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
        }
        #youtube-player {
            width: 100%;
            flex: 1;
            min-height: 0;
            display: none;
            position: relative;
        }
        #youtube-player.loaded {
            display: block;
        }
        /* Ensure YouTube API creates full-size player */
        #youtube-player > div {
            width: 100% !important;
            height: 100% !important;
            position: relative !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        #youtube-player iframe {
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            border: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .thumbnail-container {
            width: 100%;
            flex: 1;
            min-height: 0;
            position: relative;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .thumbnail-container.hidden {
            display: none;
        }
        .thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        .thumbnail-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 68px;
            height: 48px;
            background: rgba(23, 35, 34, 0.9);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .thumbnail-play-button:hover {
            background: rgba(255, 0, 0, 0.9);
        }
        .thumbnail-play-button::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 24px solid #fff;
            border-top: 14px solid transparent;
            border-bottom: 14px solid transparent;
            margin-left: 4px;
        }
        .button-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1rem auto;
            flex-wrap: wrap;
        }
        .button-container.hidden {
            display: none;
        }
        .go-to-reference-btn {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: fit-content;
            margin: 0;
        }
        .go-to-reference-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.4);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        .go-to-reference-btn:active {
            transform: translateY(0);
        }
        .go-to-reference-btn.hidden {
            display: none;
        }
        .play-pause-btn {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: fit-content;
            margin: 0;
        }
        .play-pause-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        }
        .play-pause-btn:active {
            transform: translateY(0);
        }
        .play-pause-btn.hidden {
            display: none;
        }
        /* Try to hide YouTube suggestion overlays - limited due to iframe restrictions */
        #youtube-player {
            overflow: hidden;
        }
        #youtube-player iframe {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <!-- Thumbnail container - shown initially -->
    <div id="thumbnail-container" class="thumbnail-container">
        <img id="thumbnail-image" class="thumbnail-image" alt="Video thumbnail" />
        <div class="thumbnail-play-button"></div>
    </div>

    <!-- YouTube player - hidden until button is clicked -->
    <div id="youtube-player"></div>

    <!-- Button container - both buttons in same row -->
    <div id="button-container" class="button-container hidden">
        <button id="go-to-reference-btn" class="go-to-reference-btn hidden">
            <span>üéØ</span>
            <span>Go to reference</span>
        </button>
        <button id="play-pause-btn" class="play-pause-btn hidden">
            <span id="play-pause-icon">‚è∏Ô∏è</span>
            <span id="play-pause-text">Pause</span>
        </button>
    </div>

    <!-- Load YouTube iframe API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // Helper function to extract timestamp from URL or time string
        function extractTimestamp(url) {
            if (!url) return null;

            // First, check if it's a time format like "1:17" or "1:23:45"
            const timeMatch = url.match(/^(\d+):(\d+)(?::(\d+))?$/);
            if (timeMatch) {
                const hours = timeMatch[3] ? parseInt(timeMatch[1]) : 0;
                const minutes = timeMatch[3] ? parseInt(timeMatch[2]) : parseInt(timeMatch[1]);
                const seconds = timeMatch[3] ? parseInt(timeMatch[3]) : parseInt(timeMatch[2]);
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                return totalSeconds;
            }

            // Check URL parameter patterns
            const patterns = [
                /[?&]t=(\d+)s?/,
                /[?&]start=(\d+)/,
                /#t=(\d+)s?/,
                /[?&]time_continue=(\d+)/,
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return parseInt(match[1]);
                }
            }

            return null;
        }

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('v');
        const timestampParam = urlParams.get('timestamp') || urlParams.get('t');
        const startParam = urlParams.get('start') || '0';

        let player = null;
        let playerReady = false;
        let playerLoaded = false;
        let isPlaying = false;
        let overlayHideInterval = null;

        if (!videoId) {
            document.body.textContent = 'Missing video ID parameter. Use ?v=VIDEO_ID';
            document.body.style.color = '#fff';
            document.body.style.padding = '20px';
            document.body.style.fontFamily = 'Arial, sans-serif';
        } else {
            // Show thumbnail initially
            const thumbnailContainer = document.getElementById('thumbnail-container');
            const thumbnailImage = document.getElementById('thumbnail-image');
            const playerContainer = document.getElementById('youtube-player');
            const buttonContainer = document.getElementById('button-container');
            const goToBtn = document.getElementById('go-to-reference-btn');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playPauseIcon = document.getElementById('play-pause-icon');
            const playPauseText = document.getElementById('play-pause-text');

            // Set thumbnail image URL (max quality)
            thumbnailImage.src = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            thumbnailImage.onerror = function() {
                // Fallback to standard quality if maxresdefault doesn't exist
                this.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            };

            // Extract timestamp
            const timestamp = extractTimestamp(timestampParam);

            // Show button container and buttons if needed
            if (timestamp !== null && timestamp > 0) {
                buttonContainer.classList.remove('hidden');
                goToBtn.classList.remove('hidden');
            }

            // Function to load the YouTube player
            function loadYouTubePlayer() {
                if (playerLoaded) return;
                playerLoaded = true;

                // Hide thumbnail, show player
                thumbnailContainer.classList.add('hidden');
                playerContainer.classList.add('loaded');

                // Load YouTube API if not already loaded
                if (!window.YT || !window.YT.Player) {
                    const script = document.createElement('script');
                    script.src = 'https://www.youtube.com/iframe_api';
                    document.head.appendChild(script);
                }

                // Wait for YouTube API to load
                function onYouTubeIframeAPIReady() {
                    const currentOrigin = window.location.origin;
                    const startSeconds = parseInt(startParam) || 0;

                    // Use YouTube iframe API - same as in your component
                    // This uses the same API that doesn't show ads
                    // Get container dimensions - YouTube API needs pixel values
                    const container = document.getElementById('youtube-player');
                    // Use viewport dimensions if container not yet sized
                    const width = container.offsetWidth || window.innerWidth;
                    const height = container.offsetHeight || Math.floor(width * 9 / 16); // 16:9 aspect ratio

                    player = new YT.Player('youtube-player', {
                        width: width,
                        height: height,
                        videoId: videoId,
                        playerVars: {
                            enablejsapi: 1,
                            origin: currentOrigin,
                            start: startSeconds,
                            autoplay: 0,
                            rel: 0, // Don't show related videos from other channels
                            modestbranding: 1, // Minimal YouTube branding
                            playsinline: 1,
                            iv_load_policy: 3, // Hide video annotations
                            controls: 1, // Show player controls
                            fs: 1, // Allow fullscreen
                            cc_load_policy: 0, // Hide captions by default
                            disablekb: 0, // Allow keyboard controls
                        },
                        events: {
                            onReady: function(event) {
                                playerReady = true;
                                console.log('YouTube player ready in relay');
                                // Set referrer policy on the iframe
                                const iframe = event.target.getIframe();
                                if (iframe) {
                                    iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
                                    // Ensure iframe fills container
                                    iframe.style.width = '100%';
                                    iframe.style.height = '100%';
                                }
                                // Ensure the wrapper div also fills container
                                const wrapper = container.querySelector('div');
                                if (wrapper) {
                                    wrapper.style.width = '100%';
                                    wrapper.style.height = '100%';
                                }

                                // Show button container and play/pause button
                                buttonContainer.classList.remove('hidden');
                                playPauseBtn.classList.remove('hidden');
                                updatePlayPauseButton();

                                // If timestamp is provided and start is 0, seek to timestamp on ready (but don't autoplay)
                                if (timestamp !== null && timestamp > 0 && startSeconds === 0) {
                                    event.target.seekTo(timestamp, false); // false = don't autoplay
                                }
                            },
                            onStateChange: function(event) {
                                // Track play state
                                // YT.PlayerState.PLAYING = 1, YT.PlayerState.PAUSED = 2, YT.PlayerState.ENDED = 0
                                isPlaying = (event.data === YT.PlayerState.PLAYING);
                                updatePlayPauseButton();

                                // When paused, try to hide overlays
                                if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                                    hideVideoOverlays();
                                }
                            },
                            onError: function(event) {
                                console.error('YouTube player error:', event.data);
                            }
                        }
                    });
                }

                // If API is already loaded
                if (window.YT && window.YT.Player) {
                    onYouTubeIframeAPIReady();
                } else {
                    // Wait for API to load
                    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
                }
            }

            // "Go to reference" button click - loads player and seeks to timestamp
            goToBtn.onclick = function() {
                loadYouTubePlayer();
                // Wait a bit for player to initialize, then seek
                setTimeout(function() {
                    if (playerReady && player && timestamp !== null) {
                        player.seekTo(timestamp, true);
                        player.playVideo();
                        console.log('Seeking to timestamp:', timestamp);
                    } else if (!playerReady) {
                        // Retry if player not ready yet
                        const checkInterval = setInterval(function() {
                            if (playerReady && player && timestamp !== null) {
                                clearInterval(checkInterval);
                                player.seekTo(timestamp, true);
                                player.playVideo();
                                console.log('Seeking to timestamp:', timestamp);
                            }
                        }, 100);
                    }
                }, 500);
            };

            // Thumbnail click - just loads the player (no seeking)
            thumbnailContainer.onclick = function() {
                loadYouTubePlayer();
            };

            // Function to update play/pause button appearance
            function updatePlayPauseButton() {
                if (isPlaying) {
                    playPauseIcon.textContent = '‚è∏Ô∏è';
                    playPauseText.textContent = 'Pause';
                } else {
                    playPauseIcon.textContent = '‚ñ∂Ô∏è';
                    playPauseText.textContent = 'Play';
                }
            }

            // Function to toggle play/pause
            function togglePlayPause() {
                if (!playerReady || !player) return;

                if (isPlaying) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                }
            }

            // Function to hide video overlays (suggestions)
            function hideVideoOverlays() {
                if (!player || !playerReady) return;

                try {
                    const iframe = player.getIframe();
                    if (iframe) {
                        // Try to inject CSS to hide overlays (limited effectiveness due to iframe restrictions)
                        // Note: This may not work due to cross-origin restrictions, but we try anyway
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            // Try to hide common overlay selectors
                            const style = iframeDoc.createElement('style');
                            style.textContent = `
                                .ytp-endscreen-content,
                                .ytp-ce-element,
                                .ytp-pause-overlay-container,
                                .ytp-suggested-action,
                                .ytp-endscreen-next,
                                .html5-endscreen,
                                .ytp-ce-shadow,
                                .ytp-ce-overlay,
                                [class*="endscreen"],
                                [class*="suggested"],
                                [id*="endscreen"],
                                [id*="suggested"] {
                                    display: none !important;
                                    visibility: hidden !important;
                                    opacity: 0 !important;
                                    pointer-events: none !important;
                                }
                            `;
                            if (!iframeDoc.head.querySelector('style[data-overlay-hide]')) {
                                style.setAttribute('data-overlay-hide', 'true');
                                iframeDoc.head.appendChild(style);
                            }
                        } catch (e) {
                            // Cross-origin restriction - can't access iframe content
                            // This is expected and normal
                        }

                        // Alternative: Try to refresh the frame slightly to reduce overlay persistence
                        const currentTime = player.getCurrentTime();
                        if (currentTime > 0.1) {
                            // Very small seek (0.01 seconds) to refresh without noticeable jump
                            player.seekTo(currentTime + 0.01, true);
                            setTimeout(() => {
                                if (!isPlaying) {
                                    player.pauseVideo();
                                }
                            }, 50);
                        }
                    }
                } catch (e) {
                    // Silently fail - overlays are hard to control
                }
            }

            // Play/pause button click handler
            playPauseBtn.onclick = function() {
                if (!playerLoaded) {
                    loadYouTubePlayer();
                    // Wait for player to be ready before toggling
                    const checkReady = setInterval(function() {
                        if (playerReady && player) {
                            clearInterval(checkReady);
                            setTimeout(function() {
                                togglePlayPause();
                            }, 500);
                        }
                    }, 100);
                } else {
                    togglePlayPause();
                }
            };

            // Periodically try to hide overlays when paused (every 1 second for better effectiveness)
            setInterval(function() {
                if (playerReady && player && !isPlaying) {
                    hideVideoOverlays();
                }
            }, 1000);

            // Also try to hide overlays immediately when state changes to paused
            // This is handled in onStateChange callback
        }
    </script>
</body>
</html>
